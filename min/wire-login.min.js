/*! wire-webapp - 2018-07-16-12-04-prod */
"use strict";window.z=window.z||{},window.z.auth=z.auth||{},z.auth.AuthView={ANIMATION_DIRECTION:{HORIZONTAL_LEFT:"horizontal-left",HORIZONTAL_RIGHT:"horizontal-right",VERTICAL_BOTTOM:"vertical-bottom",VERTICAL_TOP:"vertical-top"},MODE:{ACCOUNT_LOGIN:"login",BLOCKED_COOKIES:"cookies",BLOCKED_DATABASE:"database",BLOCKED_TABS:"tabs",HISTORY:"history",LIMIT:"limit",POSTED_VERIFY:"verify",VERIFY_ACCOUNT:"account",VERIFY_CODE:"code",VERIFY_PASSWORD:"phone-password"},SECTION:{ACCOUNT:"account",BLOCKED:"blocked",HISTORY:"history",LIMIT:"limit",POSTED:"posted",VERIFY:"verify"},TYPE:{CODE:"code",EMAIL:"email",FORM:"form",MODE:"mode",PASSWORD:"password",PHONE:"phone",SECTION:"section"}},window.z=window.z||{},window.z.auth=z.auth||{},z.auth.ValidationError=class a extends Error{constructor(a,b){super(),_.isString(a)&&(a=[a]),this.types=a,this.message=z.l10n.text(b)}},window.z=window.z||{},window.z.viewModel=z.viewModel||{},z.viewModel.AuthViewModel=class a{static get CONFIG(){return{FORWARDED_URL_PARAMETERS:[z.auth.URLParameter.BOT_PROVIDER,z.auth.URLParameter.BOT_SERVICE,z.auth.URLParameter.ENVIRONMENT,z.auth.URLParameter.INTEGRATIONS,z.auth.URLParameter.LOCALE,z.auth.URLParameter.TRACKING],RESET_TIMEOUT:2e3}}constructor(a){if(this.click_on_remove_device_submit=this.click_on_remove_device_submit.bind(this),this.elementId="auth-page",this.auth=a,this.logger=new z.util.Logger("z.viewModel.AuthViewModel",z.config.LOGGER.OPTIONS),this.event_tracker=new z.tracking.EventTrackingRepository,this.audio_repository=this.auth.audio,this.asset_service=new z.assets.AssetService(this.auth.client),this.storageService=new z.storage.StorageService,this.storage_repository=new z.storage.StorageRepository(this.storageService),this.cryptography_service=new z.cryptography.CryptographyRepository(this.auth.client),this.cryptography_repository=new z.cryptography.CryptographyRepository(this.cryptography_service,this.storage_repository),this.client_service=new z.client.ClientService(this.auth.client,this.storageService),this.client_repository=new z.client.ClientRepository(this.client_service,this.cryptography_repository),this.user_mapper=new z.user.UserMapper,this.user_service=new z.user.UserService(this.auth.client),this.user_repository=new z.user.UserRepository(this.user_service,this.asset_service,void 0,this.client_repository),this.notification_service=new z.event.NotificationService(this.auth.client,this.storageService),this.web_socket_service=new z.event.WebSocketService(this.auth.client),this.event_repository=new z.event.EventRepository(this.notification_service,this.web_socket_service,void 0,this.cryptography_repository,this.user_repository),this.pending_server_request=ko.observable(!1),this.disabled_by_animation=ko.observable(!1),this.deviceReused=ko.observable(!1),this.country_code=ko.observable(""),this.country=ko.observable(""),this.password=ko.observable(""),this.persist=ko.observable(!0),this.phone_number=ko.observable(""),this.username=ko.observable(""),this.is_public_computer=ko.observable(!1),this.is_public_computer.subscribe(a=>this.persist(!a)),this.client_type=ko.pureComputed(()=>this.persist()?z.client.ClientType.PERMANENT:z.client.ClientType.TEMPORARY),this.self_user=ko.observable(),this.remove_form_error=ko.observable(!1),this.device_modal=void 0,this.permanent_devices=ko.pureComputed(()=>this.client_repository.clients().filter(a=>a.type===z.client.ClientType.PERMANENT)),this.code_digits=ko.observableArray([ko.observable(""),ko.observable(""),ko.observable(""),ko.observable(""),ko.observable(""),ko.observable("")]),this.code=ko.pureComputed(()=>this.code_digits().map(a=>a()).join("").substr(0,6)),this.code.subscribe(a=>{a.length||this._clear_errors();6===a.length&&this.verify_code()}),this.phone_number_e164=(()=>`${this.country_code()}${this.phone_number()}`),this.code_interval_id=void 0,this.code_expiration_timestamp=ko.observable(0),this.code_expiration_in=ko.observable(""),this.code_expiration_timestamp.subscribe(a=>{this.code_expiration_in(moment.unix(a).fromNow());this.code_interval_id=window.setInterval(()=>{if(a<=z.util.TimeUtil.getUnixTimestamp())return window.clearInterval(this.code_interval_id),this.code_expiration_timestamp(0);this.code_expiration_in(moment.unix(a).fromNow())},2e4)}),this.validation_errors=ko.observableArray([]),this.failed_validation_email=ko.observable(!1),this.failed_validation_password=ko.observable(!1),this.failed_validation_code=ko.observable(!1),this.failed_validation_phone=ko.observable(!1),this.can_login_phone=ko.pureComputed(()=>!this.disabled_by_animation()&&this.country_code().length>1&&this.phone_number().length),this.can_resend_code=ko.pureComputed(()=>!this.disabled_by_animation()&&this.code_expiration_timestamp()<z.util.TimeUtil.getUnixTimestamp()),this.can_resend_verification=ko.pureComputed(()=>!this.disabled_by_animation()&&this.username().length),this.can_verify_account=ko.pureComputed(()=>!this.disabled_by_animation()),this.can_verify_password=ko.pureComputed(()=>!this.disabled_by_animation()&&this.password().length),this.posted_text=ko.pureComputed(()=>z.l10n.text(z.string.authPostedResend,this.username())),this.verify_code_text=ko.pureComputed(()=>{const a=PhoneFormat.formatNumberForMobileDialing("",this.phone_number_e164())||this.phone_number_e164();return z.l10n.text(z.string.authVerifyCodeDescription,a)}),this.verify_code_timer_text=ko.pureComputed(()=>z.l10n.text(z.string.authVerifyCodeResendTimer,this.code_expiration_in())),this.visible_section=ko.observable(void 0),this.visible_mode=ko.observable(void 0),this.visible_method=ko.observable(void 0),this.account_mode=ko.observable(void 0),this.blocked_mode=ko.observable(void 0),this.blocked_mode_cookies=ko.pureComputed(()=>this.blocked_mode()===z.auth.AuthView.MODE.BLOCKED_COOKIES),this.blocked_mode_database=ko.pureComputed(()=>this.blocked_mode()===z.auth.AuthView.MODE.BLOCKED_DATABASE),this.blocked_mode_tabs=ko.pureComputed(()=>this.blocked_mode()===z.auth.AuthView.MODE.BLOCKED_TABS),this.posted_mode=ko.observable(void 0),this.posted_mode_verify=ko.pureComputed(()=>this.posted_mode()===z.auth.AuthView.MODE.POSTED_VERIFY),z.util.Environment.frontend.isLocalhost()){const a=document.createElement("script");a.id="live_reload",a.src="http://localhost:32123/livereload.js",document.body.appendChild(a),$("html").addClass("development")}ko.applyBindings(this,document.getElementById(this.elementId)),this.tabsCheckIntervalId=void 0,this.previousHash=void 0,this._init_base(),$(`.${this.elementId}`).show(),$(".auth-page-container").css({display:"flex"})}_init_base(){$(window).on("dragover drop",()=>!1).on("hashchange",this._on_hash_change.bind(this)).on("keydown",this.keydown_auth.bind(this)),this._init_page(),this.country_code((z.util.CountryCodes.getCountryCode($("[name=geoip]").attr("country"))||1).toString()),this.changed_country_code(),this.audio_repository.init()}_init_page(){Promise.resolve(this._get_hash()).then(a=>this._check_cookies(a)).then(a=>this._check_database(a)).then(()=>this._checkSingleInstance()).then(()=>{this._init_url_parameter();this._init_url_hash()}).catch(a=>{if(!(a instanceof z.auth.AuthError))throw a})}_init_url_hash(){const a=[z.auth.AuthView.MODE.HISTORY,z.auth.AuthView.MODE.LIMIT,z.auth.AuthView.MODE.BLOCKED_TABS,z.auth.AuthView.MODE.POSTED_VERIFY,z.auth.AuthView.MODE.VERIFY_ACCOUNT,z.auth.AuthView.MODE.VERIFY_CODE,z.auth.AuthView.MODE.VERIFY_PASSWORD];return this._has_no_hash()||a.includes(this._get_hash())?this._set_hash(z.auth.AuthView.MODE.ACCOUNT_LOGIN):this._on_hash_change()}_init_url_parameter(){const a=z.util.URLUtil.getParameter(z.auth.URLParameter.MODE);if(a){const b=a===z.auth.AuthView.MODE.ACCOUNT_LOGIN;if(b)return this._set_hash(a)}const b=z.util.URLUtil.getParameter(z.auth.URLParameter.REASON);if(b){const a=b===z.auth.SIGN_OUT_REASON.ACCOUNT_REGISTRATION;if(a)return this._loginFromTeams()}}_check_cookies(a){const b=z.main.App.CONFIG.COOKIES_CHECK.COOKIE_NAME,c=()=>{a===z.auth.AuthView.MODE.BLOCKED_COOKIES&&this._set_hash();return Promise.resolve(a)},d=()=>{if(a!==z.auth.AuthView.MODE.BLOCKED_COOKIES)throw this._set_hash(z.auth.AuthView.MODE.BLOCKED_COOKIES),new z.auth.AuthError(z.auth.AuthError.TYPE.COOKIES_DISABLED)};switch(navigator.cookieEnabled){case!0:return c();case!1:return d();default:return Cookies.set(b,"yes"),Cookies.get(b)?(Cookies.remove(b),c()):d()}}_check_database(a){return z.util.checkIndexedDb().then(()=>{a===z.auth.AuthView.MODE.BLOCKED_DATABASE&&this._set_hash()}).catch(b=>{if(a!==z.auth.AuthView.MODE.BLOCKED_DATABASE)throw this._set_hash(z.auth.AuthView.MODE.BLOCKED_DATABASE),b})}_checkSingleInstance(){if(!z.util.Environment.electron){this.tabsCheckIntervalId||this._setTabsCheckInterval();const a=!!Cookies.get(z.main.App.CONFIG.TABS_CHECK.COOKIE_NAME);if(a){const a=this._get_hash();if(!this.previousHash){this.previousHash=a;const b=a===z.auth.AuthView.MODE.BLOCKED_TABS;b?this._on_hash_change():this._set_hash(z.auth.AuthView.MODE.BLOCKED_TABS)}return Promise.reject(new z.auth.AuthError(z.auth.AuthError.TYPE.MULTIPLE_TABS))}}return Promise.resolve()}_clearTabsCheckInterval(){this.tabsCheckIntervalId&&(window.clearInterval(this.tabsCheckIntervalId),this.tabsCheckIntervalId=void 0)}_setTabsCheckInterval(){this.tabsCheckIntervalId=window.setInterval(()=>{this._checkSingleInstance().then(()=>{const a=this._get_hash();const b=a===z.auth.AuthView.MODE.BLOCKED_TABS;if(b&&(this._init_url_parameter(),this.previousHash)){const a=this.previousHash===z.auth.AuthView.MODE.BLOCKED_TABS,b=a?z.auth.AuthView.MODE.ACCOUNT_LOGIN:this.previousHash;this.previousHash=void 0,this._set_hash(b)}}).catch(a=>{const b=a.type===z.auth.AuthError.TYPE.MULTIPLE_TABS;if(!b)throw a})},500),$(window).on("unload",()=>this._clearTabsCheckInterval())}_loginFromTeams(){this.pending_server_request(!0),z.util.StorageUtil.setValue(z.storage.StorageKey.AUTH.PERSIST,!0),z.util.StorageUtil.setValue(z.storage.StorageKey.AUTH.SHOW_LOGIN,!0),this.auth.repository.getAccessToken().then(()=>{amplify.publish(z.event.WebApp.ANALYTICS.EVENT,z.tracking.EventName.ACCOUNT.LOGGED_IN,{context:"auto",remember_me:this.persist()});this._authentication_successful(!0)}).catch(a=>{this.pending_server_request(!1);throw a})}login_phone(){const a=this.can_login_phone()&&this._validate_input(z.auth.AuthView.MODE.ACCOUNT_LOGIN);if(!this.pending_server_request()&&a){const a=a=>{window.clearInterval(this.code_interval_id);a.expires_in?this.code_expiration_timestamp(z.util.TimeUtil.getUnixTimestamp()+a.expires_in):a.label||this.code_expiration_timestamp(z.util.TimeUtil.getUnixTimestamp()+z.config.LOGIN_CODE_EXPIRATION);this._set_hash(z.auth.AuthView.MODE.VERIFY_CODE);this.pending_server_request(!1)};this.pending_server_request(!0);const b=this._create_payload(z.auth.AuthView.MODE.ACCOUNT_LOGIN);this.auth.repository.requestLoginCode(b).then(b=>a(b)).catch(b=>{this.pending_server_request(!1);if(navigator.onLine)switch(b.label){case z.service.BackendClientError.LABEL.BAD_REQUEST:this._add_error(z.string.authErrorPhoneNumberInvalid,z.auth.AuthView.TYPE.PHONE);break;case z.service.BackendClientError.LABEL.INVALID_PHONE:this._add_error(z.string.authErrorPhoneNumberUnknown,z.auth.AuthView.TYPE.PHONE);break;case z.service.BackendClientError.LABEL.PASSWORD_EXISTS:this._set_hash(z.auth.AuthView.MODE.VERIFY_PASSWORD);break;case z.service.BackendClientError.LABEL.PENDING_LOGIN:a(b);break;case z.service.BackendClientError.LABEL.PHONE_BUDGET_EXHAUSTED:this._add_error(z.string.authErrorPhoneNumberBudget,z.auth.AuthView.TYPE.PHONE);break;case z.service.BackendClientError.LABEL.SUSPENDED:this._add_error(z.string.authErrorSuspended);break;case z.service.BackendClientError.LABEL.UNAUTHORIZED:this._add_error(z.string.authErrorPhoneNumberForbidden,z.auth.AuthView.TYPE.PHONE);break;default:this._add_error(z.string.authErrorMisc)}else this._add_error(z.string.authErrorOffline);this._has_errors()})}}verify_account(){const a=this.can_verify_account()&&this._validate_input(z.auth.AuthView.MODE.VERIFY_ACCOUNT);!this.pending_server_request()&&a&&(this.pending_server_request(!0),this.user_service.change_own_password(this.password()).catch(a=>{this.logger.warn(`Could not change user password: ${a.message}`,a);if(a.code!==z.service.BackendClientError.STATUS_CODE.FORBIDDEN)throw a}).then(()=>this.user_service.change_own_email(this.username())).then(()=>{this.pending_server_request(!1);this._wait_for_update();this._set_hash(z.auth.AuthView.MODE.POSTED_VERIFY)}).catch(a=>{this.logger.warn(`Could not verify account: ${a.message}`,a);this.pending_server_request(!1);if(a){switch(a.label){case z.service.BackendClientError.LABEL.BLACKLISTED_EMAIL:this._add_error(z.string.authErrorEmailForbidden,z.auth.AuthView.TYPE.EMAIL);break;case z.service.BackendClientError.LABEL.KEY_EXISTS:this._add_error(z.string.authErrorEmailExists,z.auth.AuthView.TYPE.EMAIL);break;case z.service.BackendClientError.LABEL.INVALID_EMAIL:this._add_error(z.string.authErrorEmailMalformed,z.auth.AuthView.TYPE.EMAIL);break;default:this._add_error(z.string.authErrorEmailMalformed,z.auth.AuthView.TYPE.EMAIL)}return this._has_errors()}}))}verify_code(){if(!this.pending_server_request()&&this._validate_code()){this.pending_server_request(!0);const a=this._create_payload(z.auth.AuthView.MODE.VERIFY_CODE);this.auth.repository.login(a,this.persist()).then(()=>{amplify.publish(z.event.WebApp.ANALYTICS.EVENT,z.tracking.EventName.ACCOUNT.LOGGED_IN,{context:z.auth.AuthView.TYPE.PHONE,remember_me:this.persist()});this._authentication_successful()}).catch(()=>{this.validation_errors().length||(this._add_error(z.string.authErrorCode,z.auth.AuthView.TYPE.CODE),this._has_errors());this.pending_server_request(!1)})}}verify_password(){if(!this.pending_server_request()&&this._validate_input(z.auth.AuthView.MODE.VERIFY_PASSWORD)){this.pending_server_request(!0);const a=this._create_payload(z.auth.AuthView.MODE.VERIFY_PASSWORD);this.auth.repository.login(a,this.persist()).then(()=>{amplify.publish(z.event.WebApp.ANALYTICS.EVENT,z.tracking.EventName.ACCOUNT.LOGGED_IN,{context:z.auth.AuthView.TYPE.PHONE,remember_me:this.persist()});this._authentication_successful()}).catch(a=>{this.pending_server_request(!1);$("#wire-verify-password").focus();navigator.onLine?a.label?a.label===z.service.BackendClientError.LABEL.PENDING_ACTIVATION?this._add_error(z.string.authErrorPending):this._add_error(z.string.authErrorSignIn,z.auth.AuthView.TYPE.PASSWORD):this._add_error(z.string.authErrorMisc):this._add_error(z.string.authErrorOffline);this._has_errors()})}}_create_payload(a){switch(a){case z.auth.AuthView.MODE.ACCOUNT_LOGIN:return{force:!1,phone:this.phone_number_e164()};case z.auth.AuthView.MODE.VERIFY_CODE:return{code:this.code(),label:this.client_repository.constructCookieLabel(this.phone_number_e164(),this.client_type()),label_key:this.client_repository.constructCookieLabelKey(this.phone_number_e164(),this.client_type()),phone:this.phone_number_e164()};case z.auth.AuthView.MODE.VERIFY_PASSWORD:return{label:this.client_repository.constructCookieLabel(this.phone_number_e164(),this.client_type()),label_key:this.client_repository.constructCookieLabelKey(this.phone_number_e164(),this.client_type()),password:this.password(),phone:this.phone_number_e164()};default:this.logger.warn(`Unsupported payload of type '${a}' requested`)}}changed_country(a,b){this.clear_error(z.auth.AuthView.TYPE.PHONE);const c=b?b.currentTarget.value||void 0:this.country();this.country_code(`+${z.util.CountryCodes.getCountryCode(c)}`),$("#wire-login-phone").focus()}changed_country_code(a,b){let c;const d=b?b.currentTarget.value:this.country_code(),e=d.match(/\d+/g)||[],f=e.join("").substr(0,4);f?(this.country_code(`+${f}`),c=z.util.CountryCodes.getCountryByCode(f)||"X1"):(this.country_code(""),c="X0"),this.country(c),$("#wire-login-phone").focus()}changed_phone_number(){const a=this.phone_number(),b=this.phone_number().match(/\d+/g)||[],c=b.join("");this.phone_number(c),a.length&&!this.phone_number().length&&this._add_error(z.string.authErrorPhoneNumberInvalid,z.auth.AuthView.TYPE.PHONE)}clear_error(a,b){const c=b?b.currentTarget.classList[1]:a;this._remove_error(c)}clear_error_password(a,b){this.failed_validation_password(!1),(!b.currentTarget.value.length||b.currentTarget.value.length>=8)&&this._remove_error(b.currentTarget.classList[1])}clicked_on_change_phone(){this._set_hash(z.auth.AuthView.MODE.ACCOUNT_LOGIN)}clickOnHandover(){Cookies.remove(z.main.App.CONFIG.TABS_CHECK.COOKIE_NAME),this._checkSingleInstance()}clicked_on_password(){z.util.safeWindowOpen(z.util.URLUtil.buildUrl(z.util.URLUtil.TYPE.ACCOUNT,z.config.URL_PATH.PASSWORD_RESET))}clicked_on_resend_code(){this.can_resend_code()&&this.login_phone()}clicked_on_resend_registration(){}clicked_on_resend_verification(){this.can_resend_verification&&(this._fade_in_icon_spinner(),this.pending_server_request()||(this.pending_server_request(!0),this.user_service.change_own_email(this.username()).then(a=>this._on_resend_success(a)).catch(()=>{this.pending_server_request(!1);$(".icon-spinner").fadeOut();window.setTimeout(()=>{$(".icon-error").fadeIn();this.disabled_by_animation(!1)},z.motion.MotionDuration.LONG)})))}clicked_on_wire_link(){const a=z.l10n.text(z.string.urlWebsiteRoot);z.util.safeWindowOpen(z.util.URLUtil.buildUrl(z.util.URLUtil.TYPE.WEBSITE,a))}keydown_auth(a){if(z.util.KeyboardUtil.isEnterKey(a))switch(this.visible_mode()){case z.auth.AuthView.MODE.ACCOUNT_LOGIN:this.login_phone();break;case z.auth.AuthView.MODE.VERIFY_ACCOUNT:this.verify_account();break;case z.auth.AuthView.MODE.VERIFY_PASSWORD:this.verify_password();break;case z.auth.AuthView.MODE.LIMIT:this.device_modal&&!this.device_modal.is_hidden()||this.clicked_on_manage_devices();break;case z.auth.AuthView.MODE.HISTORY:this.click_on_history_confirm()}}keydown_phone_code(a,b){if(z.util.KeyboardUtil.isPasteAction(b))return!0;if(z.util.KeyboardUtil.isFunctionKey(b))return!1;const c=b.currentTarget.id,d=window.parseInt(c.substr(c.length-1));let e;switch(b.key){case z.util.KeyboardUtil.KEY.ARROW_LEFT:case z.util.KeyboardUtil.KEY.ARROW_UP:e=d-1,$(`#wire-verify-code-digit-${Math.max(1,e)}`).focus();break;case z.util.KeyboardUtil.KEY.ARROW_DOWN:case z.util.KeyboardUtil.KEY.ARROW_RIGHT:e=d+1,$(`#wire-verify-code-digit-${Math.min(6,e)}`).focus();break;case z.util.KeyboardUtil.KEY.BACKSPACE:case z.util.KeyboardUtil.KEY.DELETE:return""===b.currentTarget.value&&(e=d-1,$(`#wire-verify-code-digit-${Math.max(1,e)}`).focus()),!0;default:{const a=String.fromCharCode(b.keyCode).match(/\d+/g)||String.fromCharCode(b.keyCode-48).match(/\d+/g);a&&(this.code_digits()[d-1](a),e=d+1,$(`#wire-verify-code-digit-${Math.min(6,e)}`).focus())}}}input_phone_code(a,b){const c=b.currentTarget.id,d=window.parseInt(c.substr(c.length-1)),e=d-1,f=b.currentTarget.value.match(/\d+/g)||[],g=f.join("");if(g){const a=d+g.length;$(`#wire-phone-code-digit-${Math.min(6,a)}`).focus();const b=g.substr(0,6-e).split("");b.map((a,b)=>this.code_digits()[e+b](a))}else this.code_digits()[e](null)}clicked_on_manage_devices(){if(!this.device_modal){const a=$(document).off("keydown.deviceModal");this.device_modal=new zeta.webapp.module.Modal("#modal-limit",a),this.device_modal.autoclose=!1}this.device_modal.is_hidden()&&(this.client_repository.getClientsForSelf(),$(document).on("keydown.deviceModal",a=>{z.util.KeyboardUtil.isEscapeKey(a)&&this.device_modal.hide()})),this.device_modal.show()}close_model_manage_devices(){this.device_modal.hide()}clicked_on_navigate_back(){const a=this._append_existing_parameters("/auth/#login");window.location.replace(a)}click_on_remove_device_submit(a,b){this.client_repository.deleteClient(b.id,a).then(()=>this._register_client()).then(()=>this.device_modal.toggle()).catch(a=>{this.remove_form_error(!0);this.logger.error(`Unable to replace device: ${a.message}`,a)})}click_on_history_confirm(){this._redirect_to_app()}_on_resend_success(){this.pending_server_request(!1),$(".icon-spinner").fadeOut(),window.setTimeout(()=>{$(".icon-check").fadeIn()},z.motion.MotionDuration.LONG),window.setTimeout(()=>{$(".icon-check").fadeOut();$(".icon-envelope").fadeIn();this.disabled_by_animation(!1)},a.CONFIG.RESET_TIMEOUT)}_wait_for_update(){this.logger.info("Opened WebSocket connection to wait for user update"),this.web_socket_service.connect(a=>{const[b]=a.payload;const{type:event_type,user:user}=b;const c=event_type===z.event.Backend.USER.UPDATE;this.logger.info(`»» Event: '${event_type}'`,{event_json:JSON.stringify(b),event_object:b});c&&user.email&&(this.logger.info("User account verified. User can now login."),this._authentication_successful())})}_show_account_login(){const a={focus:"wire-login-phone",mode:z.auth.AuthView.MODE.ACCOUNT_LOGIN,section:z.auth.AuthView.SECTION.ACCOUNT};this.switch_ui(a)}_show_blocked_cookies(){const a={mode:z.auth.AuthView.MODE.BLOCKED_COOKIES,section:z.auth.AuthView.SECTION.BLOCKED};this.switch_ui(a)}_show_blocked_database(){const a={mode:z.auth.AuthView.MODE.BLOCKED_DATABASE,section:z.auth.AuthView.SECTION.BLOCKED};this.switch_ui(a)}_show_blocked_tabs(){const a={mode:z.auth.AuthView.MODE.BLOCKED_TABS,section:z.auth.AuthView.SECTION.BLOCKED};this.switch_ui(a)}_show_history(){const a={mode:z.auth.AuthView.MODE.HISTORY,section:z.auth.AuthView.SECTION.HISTORY};this.switch_ui(a)}_show_limit(){const a={mode:z.auth.AuthView.MODE.LIMIT,section:z.auth.AuthView.SECTION.LIMIT};this.switch_ui(a)}_show_posted_verify(){this._show_icon_envelope();const a={mode:z.auth.AuthView.MODE.POSTED_VERIFY,section:z.auth.AuthView.SECTION.POSTED};this.switch_ui(a)}_show_verify_account(){const a={focus:"wire-verify-account-email",mode:z.auth.AuthView.MODE.VERIFY_ACCOUNT,section:z.auth.AuthView.SECTION.VERIFY};this.switch_ui(a)}_show_verify_code(){const a={focus:"wire-verify-code-digit-1",mode:z.auth.AuthView.MODE.VERIFY_CODE,section:z.auth.AuthView.SECTION.VERIFY};this.switch_ui(a),$("#wire-phone-code-digit-1").focus()}_show_verify_password(){const a={focus:"wire-verify-password-input",mode:z.auth.AuthView.MODE.VERIFY_PASSWORD,section:z.auth.AuthView.SECTION.VERIFY};this.switch_ui(a)}switch_ui(a){let b,c;this.visible_section()===z.auth.AuthView.SECTION.ACCOUNT?a.section!==z.auth.AuthView.SECTION.ACCOUNT&&(c=z.auth.AuthView.ANIMATION_DIRECTION.HORIZONTAL_LEFT):this.visible_section()===z.auth.AuthView.SECTION.POSTED?a.section===z.auth.AuthView.SECTION.ACCOUNT&&(c=z.auth.AuthView.ANIMATION_DIRECTION.HORIZONTAL_RIGHT):this.visible_section()===z.auth.AuthView.SECTION.VERIFY&&(a.section===z.auth.AuthView.SECTION.ACCOUNT?c=z.auth.AuthView.ANIMATION_DIRECTION.HORIZONTAL_RIGHT:a.section===z.auth.AuthView.SECTION.POSTED?c=z.auth.AuthView.ANIMATION_DIRECTION.HORIZONTAL_LEFT:this.visible_mode()===z.auth.AuthView.MODE.VERIFY_CODE&&a.mode===z.auth.AuthView.TYPE.EMAIL&&(c=z.auth.AuthView.ANIMATION_DIRECTION.HORIZONTAL_LEFT)),a.section===z.auth.AuthView.SECTION.ACCOUNT?this.account_mode(a.mode):a.section===z.auth.AuthView.SECTION.BLOCKED?this.blocked_mode(a.mode):a.section===z.auth.AuthView.SECTION.POSTED&&this.posted_mode(a.mode),this._clear_animations(z.auth.AuthView.TYPE.SECTION),a.section!==this.visible_section()&&(b={direction:c,section:a.section,type:z.auth.AuthView.TYPE.SECTION},this._shift_ui(b)),this._clear_animations(z.auth.AuthView.TYPE.FORM),a.mode!==this.visible_mode()&&(b={direction:c,section:a.section,selector:a.mode,type:z.auth.AuthView.TYPE.FORM},this._shift_ui(b)),a.method||this.visible_method()?a.method&&this.visible_method()!==a.method&&(this._show_method(a.method),this.visible_method(a.method)):(this._show_method(z.auth.AuthView.MODE.ACCOUNT_LOGIN),this.visible_method(z.auth.AuthView.MODE.ACCOUNT_LOGIN)),a.focus&&$(`#${a.focus}`).focus_field()}_show_method(a){this._clear_errors(),$(".selector-method").find(".button").removeClass("is-active"),$(`.btn-login-${a}`).addClass("is-active"),$(".method:visible").hide().css({opacity:0}),$(`#login-method-${a}`).show().css({opacity:1})}_shift_ui(a){const b=$(`.${a.type}:visible`);let c=$(`#${a.type}-${a.section}`);a.selector&&(c=$(`#${a.type}-${a.section}-${a.selector}`)),c.show();const d=()=>{switch(a.type){case z.auth.AuthView.TYPE.FORM:return this.visible_mode(a.selector);case z.auth.AuthView.TYPE.SECTION:return this.visible_section(a.section)}};a.direction?(this.disabled_by_animation(!0),window.requestAnimationFrame(()=>{const e=[];b.length&&e.push(new Promise(c=>{$(b[0]).addClass(`outgoing-${a.direction}`).one(z.util.alias.animationend,function(){c(),$(this).css({display:"",opacity:""})})}));c.length&&e.push(new Promise(b=>{c.addClass(`incoming-${a.direction}`).one(z.util.alias.animationend,function(){b(),$(this).css({opacity:1})})}));Promise.all(e).then(()=>{d();this.disabled_by_animation(!1)})})):(b.css({display:"",opacity:""}),c.css({opacity:1}),d())}_clear_animations(a=z.auth.AuthView.TYPE.FORM){$(`.${a}`).off(z.util.alias.animationend).removeClass((a,b)=>(b.match(/\boutgoing-\S+/g)||[]).join(" ")).removeClass((a,b)=>(b.match(/\bincoming-\S+/g)||[]).join(" "))}_fade_in_icon_spinner(){this.disabled_by_animation(!0),$(".icon-envelope").fadeOut(),$(".icon-spinner").fadeIn()}_show_icon_envelope(){$(".icon-envelope").show()}_set_hash(a=""){window.location.hash=a}_get_hash(){return window.location.hash.substr(1)}_has_no_hash(){return 0===window.location.hash.length}_on_hash_change(){switch(this._clear_errors(),this._get_hash()){case z.auth.AuthView.MODE.ACCOUNT_LOGIN:this._show_account_login();break;case z.auth.AuthView.MODE.BLOCKED_COOKIES:this._show_blocked_cookies();break;case z.auth.AuthView.MODE.BLOCKED_DATABASE:this._show_blocked_database();break;case z.auth.AuthView.MODE.BLOCKED_TABS:this._show_blocked_tabs();break;case z.auth.AuthView.MODE.HISTORY:this._show_history();break;case z.auth.AuthView.MODE.LIMIT:this._show_limit();break;case z.auth.AuthView.MODE.POSTED_VERIFY:this._show_posted_verify();break;case z.auth.AuthView.MODE.VERIFY_ACCOUNT:this._show_verify_account();break;case z.auth.AuthView.MODE.VERIFY_CODE:this._show_verify_code();break;case z.auth.AuthView.MODE.VERIFY_PASSWORD:this._show_verify_password();break;default:this._show_account_login()}}_add_error(a,b){const c=new z.auth.ValidationError(b||[],a);this.validation_errors.push(c),c.types.map(a=>{switch(a){case z.auth.AuthView.TYPE.CODE:this.failed_validation_code(!0);break;case z.auth.AuthView.TYPE.EMAIL:this.failed_validation_email(!0);break;case z.auth.AuthView.TYPE.PASSWORD:this.failed_validation_password(!0);break;case z.auth.AuthView.TYPE.PHONE:this.failed_validation_phone(!0)}})}_clear_errors(){this.failed_validation_code(!1),this.failed_validation_email(!1),this.failed_validation_password(!1),this.failed_validation_phone(!1),this.validation_errors([])}_get_error_by_type(a){return ko.utils.arrayFirst(this.validation_errors(),({types:error_types})=>error_types.includes(a))}_has_errors(){let a=!1;return this.validation_errors().length>0&&(amplify.publish(z.event.WebApp.AUDIO.PLAY,z.audio.AudioType.ALERT),a=!0),a}_remove_error(a){switch(this.validation_errors.remove(this._get_error_by_type(a)),a){case z.auth.AuthView.TYPE.CODE:this.failed_validation_code(!1);break;case z.auth.AuthView.TYPE.EMAIL:this.failed_validation_email(!1);break;case z.auth.AuthView.TYPE.PASSWORD:this.failed_validation_password(!1);break;case z.auth.AuthView.TYPE.PHONE:this.failed_validation_phone(!1)}}_validate_code(){return this.code().length>=6}_validate_email(){const a=this.username().trim().toLowerCase();if(!a.length)return this._add_error(z.string.authErrorEmailMissing,z.auth.AuthView.TYPE.EMAIL);z.util.isValidEmail(a)||this._add_error(z.string.authErrorEmailMalformed,z.auth.AuthView.TYPE.EMAIL)}_validate_input(a){return this._clear_errors(),a===z.auth.AuthView.MODE.VERIFY_ACCOUNT&&this._validate_email(),[z.auth.AuthView.MODE.VERIFY_ACCOUNT,z.auth.AuthView.MODE.VERIFY_PASSWORD].includes(a)&&this._validate_password(a),[z.auth.AuthView.MODE.ACCOUNT_LOGIN,z.auth.AuthView.MODE.VERIFY_PASSWORD].includes(a)&&this._validate_phone(),!this._has_errors()}_validate_password(a){if(this.password().length<z.config.MINIMUM_PASSWORD_LENGTH){if(a===z.auth.AuthView.MODE.ACCOUNT_PASSWORD)return this._add_error(z.string.authErrorPasswordWrong,z.auth.AuthView.TYPE.PASSWORD);this._add_error(z.string.authErrorPasswordShort,z.auth.AuthView.TYPE.PASSWORD)}}_validate_phone(){z.util.isValidPhoneNumber(this.phone_number_e164())||this._add_error(z.string.authErrorPhoneNumberInvalid,z.auth.AuthView.TYPE.PHONE)}logout(){this.auth.repository.logout().then(()=>{this.auth.repository.deleteAccessToken();window.location.replace("/login")})}_append_existing_parameters(b){return a.CONFIG.FORWARDED_URL_PARAMETERS.forEach(a=>{b=z.util.URLUtil.forwardParameter(b,a)}),b}_authentication_successful(a=!1){this.logger.info("Logging in"),this._get_self_user().then(()=>this.cryptography_repository.loadCryptobox(this.storageService.db)).then(()=>this.client_repository.getValidLocalClient()).catch(a=>{const b=a.type===z.user.UserError.TYPE.USER_MISSING_EMAIL;if(b)throw a;const c=a.type===z.client.ClientError.TYPE.NO_VALID_CLIENT;if(c){const a=this.client_repository.currentClient();return this.client_repository.currentClient(void 0),this.cryptography_repository.resetCryptobox(a).then(a=>{if(a)return this.logger.info("Database was completely reset. Reinitializing storage..."),this.storage_repository.storageService.init(this.self_user().id)})}}).then(()=>{if(this.client_repository.currentClient())return this.logger.info("Active client found. Redirecting to app..."),this._redirect_to_app();this.logger.info("No active client found. We need to register one...");this._register_client(a)}).catch(a=>{a.type!==z.user.UserError.TYPE.USER_MISSING_EMAIL&&(this.logger.error(`Login failed: ${a.message}`,a),this._add_error(z.string.authErrorMisc),this._has_errors(),this._set_hash(z.auth.AuthView.MODE.ACCOUNT_LOGIN))})}_get_self_user(){return this.user_repository.getSelf().then(a=>{this.self_user(a);this.logger.info(`Retrieved self user: ${this.self_user().id}`);this.pending_server_request(!1);const b=this.self_user().email();const c=this.self_user().phone();const d=c&&!b;if(d)throw this._set_hash(z.auth.AuthView.MODE.VERIFY_ACCOUNT),new z.user.UserError(z.user.UserError.TYPE.USER_MISSING_EMAIL);return this.storageService.init(this.self_user().id)}).then(()=>{this.client_repository.init(this.self_user());return this.self_user()})}_hasLocalHistory(){const a=z.storage.StorageSchemata.OBJECT_STORE.EVENTS;return this.storageService.getAll(a).then(a=>a.length>0)}_redirect_to_app(){const a=this._append_existing_parameters("/");window.location.replace(a)}_register_client(a){return this.cryptography_repository.createCryptobox(this.storageService.db).then(()=>this.client_repository.registerClient(a?void 0:this.password())).then(a=>{this.event_repository.currentClient=a;return this.event_repository.setStreamState(a().id,!0)}).catch(a=>{const b=a.code===z.service.BackendClientError.STATUS_CODE.NOT_FOUND;if(b)return this.logger.warn(`Cannot set starting point on notification stream: ${a.message}`,a);throw a}).then(()=>this.client_repository.getClientsForSelf()).then(a=>{const b=a?a.length:0;this.logger.info(`User has '${b}' registered clients`,a);return this._hasLocalHistory().then(a=>{const c=a||!!b||this.client_repository.isTemporaryClient();if(c)return this.deviceReused(a),this._set_hash(z.auth.AuthView.MODE.HISTORY);this._redirect_to_app()})}).catch(b=>{const c=b.type===z.client.ClientError.TYPE.TOO_MANY_CLIENTS;if(c)return this.logger.warn("User has already registered the maximum number of clients",b),window.location.hash=z.auth.AuthView.MODE.LIMIT;this.logger.error(`Failed to register a new client: ${b.message}`,b);a&&(window.location.hash=z.auth.AuthView.MODE.ACCOUNT_LOGIN)})}},$(()=>{$(".auth-page").length&&(wire.auth.view=new z.viewModel.AuthViewModel(wire.auth))}),$.fn.extend({focus_field(){this.each(function(){window.setTimeout(()=>{$(this).focus()},0)})}});
//# sourceMappingURL=wire-login.min.js.map